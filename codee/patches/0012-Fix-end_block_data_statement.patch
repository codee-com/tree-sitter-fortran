From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?I=C3=B1aki=20Amatria=20Barral?= <inaki.amatria@appentra.com>
Date: Thu, 20 Mar 2025 14:48:08 +0100
Subject: Fix `end_block_data_statement`

This is upstreamable.
---
 grammar.js                 |  36 ++++--
 test/corpus/constructs.txt | 221 +++++++++++++++++++++++++++++++++++++
 2 files changed, 245 insertions(+), 12 deletions(-)

diff --git a/grammar.js b/grammar.js
index 54eccb3..a731ff8 100644
--- a/grammar.js
+++ b/grammar.js
@@ -401,18 +401,30 @@ module.exports = grammar({
     ),
 
     // Can't use `blockStructureEnding` because it's two keywords
-    end_block_data_statement: $ => {
-      const structType = whiteSpacedKeyword('block', 'data', false)
-      return prec.right(seq(
-        alias(choice(
-            seq(
-              caseInsensitive('end', false),
-              optional(structType)),
-            caseInsensitive('end' + structType, false)),
-          'end' + structType),
-        optional($._name),
-        $.end_of_statement))
-    },
+    end_block_data_statement: $ => seq(
+      alias(
+        choice(
+          caseInsensitive('end', false),
+          seq(
+            caseInsensitive('endblock', false),
+            caseInsensitive('data', false),
+          ),
+          seq(
+            caseInsensitive('end', false),
+            caseInsensitive('blockdata', false),
+          ),
+          seq(
+            caseInsensitive('end', false),
+            caseInsensitive('block', false),
+            caseInsensitive('data', false),
+          ),
+          caseInsensitive('endblockdata', false)
+        ),
+        'endblockdata'
+      ),
+      optional($._name),
+      $.end_of_statement
+    ),
 
     assignment: $ => seq(caseInsensitive('assignment'), '(', '=', ')'),
     operator: $ => seq(caseInsensitive('operator'), '(', /[^()]+/, ')'),
diff --git a/test/corpus/constructs.txt b/test/corpus/constructs.txt
index 2874006..3d7859c 100644
--- a/test/corpus/constructs.txt
+++ b/test/corpus/constructs.txt
@@ -1658,6 +1658,51 @@ Block Data (Obsolescent)
       DATA ICASE /4/
       END
 
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      END BLOCK DATA
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      ENDBLOCK DATA
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      ENDBLOCKDATA
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      END BLOCKDATA
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      END COMBLA
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      END BLOCK DATA combla
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      ENDBLOCK DATA combla
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      ENDBLOCKDATA combla
+
+      BLOCK DATA combla
+      COMMON /COMBLA/ ICASE, N, INCX
+      DATA ICASE /4/
+      END BLOCKDATA combla
+
 --------------------------------------------------------------------------------
 
 (translation_unit
@@ -1679,4 +1724,180 @@ Block Data (Obsolescent)
           (number_literal))))
     (end_of_statement)
     (end_block_data_statement
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (name)
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (name)
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (name)
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (name)
+      (end_of_statement)))
+  (block_data
+    (block_data_statement
+      (name)
+      (end_of_statement))
+    (common_statement
+      (variable_group
+        (name)
+        (identifier)
+        (identifier)
+        (identifier)))
+    (end_of_statement)
+    (data_statement
+      (data_set
+        (identifier)
+        (data_value
+          (number_literal))))
+    (end_of_statement)
+    (end_block_data_statement
+      (name)
       (end_of_statement))))
