From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?I=C3=B1aki=20Amatria=20Barral?= <inaki.amatria@appentra.com>
Date: Thu, 3 Apr 2025 10:57:24 +0200
Subject: Ensure nodes appear in the syntax tree

Previously, these nodes were defined using regexes, preventing them
from being explicitly represented in the tree.
---
 grammar.js                  | 11 ++++++----
 test/corpus/constructs.txt  | 24 ++++++++++++++-------
 test/corpus/expressions.txt |  4 ++++
 test/corpus/statements.txt  | 43 ++++++++++++++++++++++++++-----------
 4 files changed, 57 insertions(+), 25 deletions(-)

diff --git a/grammar.js b/grammar.js
index 07410f4..18eac7e 100644
--- a/grammar.js
+++ b/grammar.js
@@ -428,7 +428,8 @@ module.exports = grammar({
     ),
 
     assignment: $ => seq(caseInsensitive('assignment'), '(', '=', ')'),
-    operator: $ => seq(caseInsensitive('operator'), '(', /[^()]+/, ')'),
+    operator: $ => seq(caseInsensitive('operator'), '(', $.operator_name, ')'),
+    operator_name: $ => /[^()]+/,
     defined_io_procedure: $ => seq(
       choice(caseInsensitive('read'), caseInsensitive('write')),
       '(',
@@ -689,9 +690,10 @@ module.exports = grammar({
     ),
 
     implicit_range: $ => seq(
-      /[a-zA-Z]/,
-      optional(seq('-', /[a-zA-Z]/))
+      $.implicit_range_letter,
+      optional(seq('-', $.implicit_range_letter))
     ),
+    implicit_range_letter: $ => /[a-zA-Z]/,
 
     import_statement: $ => prec.left(seq(
       caseInsensitive('import'),
@@ -1934,8 +1936,9 @@ module.exports = grammar({
     )),
 
     user_defined_operator: $ => prec.right(seq(
-      '.', /[a-zA-Z]+/, '.'
+      '.', $.user_defined_operator_name, '.'
     )),
+    user_defined_operator_name: $ => /[a-zA-Z]+/,
 
     // Due to the fact Fortran uses parentheses for both function calls and
     // array access there is no way to differentiate the two except for the
diff --git a/test/corpus/constructs.txt b/test/corpus/constructs.txt
index 3d7859c..c3a4680 100644
--- a/test/corpus/constructs.txt
+++ b/test/corpus/constructs.txt
@@ -416,7 +416,8 @@ end interface operator (.not.)
 (translation_unit
   (interface
     (interface_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
@@ -429,11 +430,13 @@ end interface operator (.not.)
         (name))
       (end_of_statement))
     (end_interface_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement)))
   (interface
     (interface_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
@@ -458,7 +461,8 @@ end interface operator (.not.)
       (end_function_statement
         (end_of_statement)))
     (end_interface_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement))))
 
 ================================================================================
@@ -496,7 +500,8 @@ interface operator(+) ; module procedure test_plus ; end interface
 (translation_unit
   (interface
     (interface_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
@@ -527,14 +532,16 @@ end module
       (module_name
         (name))
       (included_items
-        (operator)
+        (operator
+          (operator_name))
         (assignment)))
     (end_of_statement)
     (public_statement
       (assignment)
       (end_of_statement))
     (private_statement
-      (operator)
+      (operator
+        (operator_name))
       (end_of_statement))
     (end_module_statement
       (end_of_statement))))
@@ -1076,7 +1083,8 @@ end program
           (procedure_attribute)
           (binding
             (binding_name
-              (operator))
+              (operator
+                (operator_name)))
             (method_name
               (name)))
           (end_of_statement))
diff --git a/test/corpus/expressions.txt b/test/corpus/expressions.txt
index 0e9e317..84cfa97 100644
--- a/test/corpus/expressions.txt
+++ b/test/corpus/expressions.txt
@@ -1050,8 +1050,12 @@ end program
             (argument_list
               (number_literal)))
           (ERROR
+            (implicit_range_letter)
+            (implicit_range_letter)
+            (implicit_range_letter)
             (ERROR
               (number_literal))
+            (user_defined_operator_name)
             (number_literal))
           (number_literal))))
     (end_of_statement)
diff --git a/test/corpus/statements.txt b/test/corpus/statements.txt
index 8a08571..98e8ccf 100644
--- a/test/corpus/statements.txt
+++ b/test/corpus/statements.txt
@@ -209,17 +209,26 @@ END PROGRAM
       (end_of_statement))
     (implicit_statement
       (intrinsic_type)
-      (implicit_range)
+      (implicit_range
+        (implicit_range_letter)
+        (implicit_range_letter))
       (intrinsic_type
         (kind
           (number_literal)))
-      (implicit_range)
+      (implicit_range
+        (implicit_range_letter)
+        (implicit_range_letter))
       (intrinsic_type
         (kind
           (number_literal)))
-      (implicit_range)
-      (implicit_range)
-      (implicit_range))
+      (implicit_range
+        (implicit_range_letter)
+        (implicit_range_letter))
+      (implicit_range
+        (implicit_range_letter))
+      (implicit_range
+        (implicit_range_letter)
+        (implicit_range_letter)))
     (end_of_statement)
     (implicit_statement
       (none))
@@ -278,8 +287,10 @@ END MODULE
     (private_statement
       (identifier)
       (identifier)
-      (operator)
-      (operator)
+      (operator
+        (operator_name))
+      (operator
+        (operator_name))
       (end_of_statement))
     (end_module_statement
       (end_of_statement))))
@@ -305,8 +316,10 @@ END MODULE
     (public_statement
       (identifier)
       (identifier)
-      (operator)
-      (operator)
+      (operator
+        (operator_name))
+      (operator
+        (operator_name))
       (end_of_statement))
     (end_module_statement
       (end_of_statement))))
@@ -2604,7 +2617,8 @@ end program
       (end_of_statement))
     (interface
       (interface_statement
-        (operator)
+        (operator
+          (operator_name))
         (end_of_statement))
       (function
         (function_statement
@@ -2625,7 +2639,8 @@ end program
         (end_of_statement)))
     (interface
       (interface_statement
-        (operator)
+        (operator
+          (operator_name))
         (end_of_statement))
       (function
         (function_statement
@@ -2655,7 +2670,8 @@ end program
       (format_identifier)
       (output_item_list
         (unary_expression
-          (user_defined_operator)
+          (user_defined_operator
+            (user_defined_operator_name))
           (identifier))))
     (end_of_statement)
     (print_statement
@@ -2663,7 +2679,8 @@ end program
       (output_item_list
         (math_expression
           (identifier)
-          (user_defined_operator)
+          (user_defined_operator
+            (user_defined_operator_name))
           (identifier))))
     (end_of_statement)
     (end_program_statement
