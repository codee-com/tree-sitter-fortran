From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?I=C3=B1aki=20Amatria=20Barral?= <inaki.amatria@appentra.com>
Date: Tue, 18 Mar 2025 15:38:42 +0100
Subject: Unalias nodes

These `alias`es are meaningless and may provoke duplicate visitations
for third-party applications.
---
 grammar.js                   | 12 +++---
 queries/highlights.scm       |  2 +-
 test/corpus/constructs.txt   | 76 ++++++++++++++++++++++++------------
 test/corpus/cudafortran.txt  |  3 +-
 test/corpus/preprocessor.txt | 16 +++++---
 test/corpus/regressions.txt  |  6 ++-
 test/corpus/statements.txt   | 48 ++++++++++++++---------
 7 files changed, 103 insertions(+), 60 deletions(-)

diff --git a/grammar.js b/grammar.js
index 3b583ef..f440aa5 100644
--- a/grammar.js
+++ b/grammar.js
@@ -603,7 +603,7 @@ module.exports = grammar({
         ),
         optional('::')
       ),
-      alias($.identifier, $.module_name),
+      $.module_name,
       optional(
         choice(
           seq(',', commaSep1($.use_alias)),
@@ -737,7 +737,7 @@ module.exports = grammar({
           choice(
             $.public_statement,
             $.private_statement,
-            alias(caseInsensitive('sequence'), $.sequence_statement),
+            caseInsensitive('sequence'),
             $.include_statement,
           ),
           $.end_of_statement
@@ -827,7 +827,7 @@ module.exports = grammar({
       $.identifier,
       $._generic_procedure
     ),
-    method_name: $ => alias($.identifier, 'method_name'),
+    method_name: $ => $._name,
 
     procedure_kind: $ => choice(
       caseInsensitive('generic'),
@@ -1576,7 +1576,7 @@ module.exports = grammar({
       caseInsensitive('case'),
       choice(
         seq('(', $.case_value_range_list, ')'),
-        alias(caseInsensitive('default'), $.default)
+        caseInsensitive('default')
       ),
       optional($._block_label),
       $.end_of_statement,
@@ -1594,7 +1594,7 @@ module.exports = grammar({
             seq('(', field('type', choice($.intrinsic_type, $.identifier)), ')'),
           ),
         ),
-        alias($._class_default, $.default)
+        $._class_default
       ),
       optional($._block_label),
       $.end_of_statement,
@@ -1613,7 +1613,7 @@ module.exports = grammar({
       caseInsensitive('rank'),
       choice(
         seq('(', $.case_value_range_list, ')'),
-        alias(caseInsensitive('default'), $.default)
+        caseInsensitive('default')
       ),
       optional($._block_label),
       $.end_of_statement,
diff --git a/queries/highlights.scm b/queries/highlights.scm
index 7511b3d..e729dd8 100644
--- a/queries/highlights.scm
+++ b/queries/highlights.scm
@@ -46,7 +46,7 @@
  ] @keyword.function
 
 [
- (default)
+ "default"
  (procedure_qualifier)
  "abstract"
  "bind"
diff --git a/test/corpus/constructs.txt b/test/corpus/constructs.txt
index 8189fde..f2b3f31 100644
--- a/test/corpus/constructs.txt
+++ b/test/corpus/constructs.txt
@@ -82,7 +82,8 @@ end module
     (private_statement)
     (end_of_statement)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (interface
       (interface_statement
@@ -90,10 +91,12 @@ end module
         (end_of_statement))
       (procedure_statement
         (procedure_kind)
-        (method_name))
+        (method_name
+          (name)))
       (procedure_statement
         (procedure_kind)
-        (method_name))
+        (method_name
+          (name)))
       (end_interface_statement
         (end_of_statement)))
     (variable_declaration
@@ -378,10 +381,12 @@ end interface
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (end_interface_statement
       (end_of_statement))))
 
@@ -412,10 +417,12 @@ end interface operator (.not.)
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (end_interface_statement
       (operator
         (operator_name))
@@ -427,7 +434,8 @@ end interface operator (.not.)
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (function
       (function_statement
         (name)
@@ -467,7 +475,8 @@ end interface assignment (=)
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (end_interface_statement
       (assignment)
       (end_of_statement))))
@@ -488,7 +497,8 @@ interface operator(+) ; module procedure test_plus ; end interface
       (end_of_statement))
     (procedure_statement
       (procedure_kind)
-      (method_name))
+      (method_name
+        (name)))
     (end_interface_statement
       (end_of_statement))))
 
@@ -510,7 +520,8 @@ end module
       (name)
       (end_of_statement))
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (operator
           (operator_name))
@@ -721,7 +732,8 @@ end function
       (end_of_statement))
     (comment)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (assignment_statement
       (identifier)
@@ -977,7 +989,6 @@ end program
         (access_specifier)
         (type_name)
         (end_of_statement))
-      (sequence_statement)
       (end_of_statement)
       (private_statement)
       (end_of_statement)
@@ -1021,33 +1032,39 @@ end program
           (procedure_kind)
           (procedure_attribute)
           (procedure_attribute)
-          (method_name))
+          (method_name
+            (name)))
         (comment)
         (procedure_statement
           (procedure_kind)
-          (method_name))
+          (method_name
+            (name)))
         (comment)
         (procedure_statement
           (procedure_kind)
           (procedure_attribute)
           (procedure_attribute
             (identifier))
-          (method_name))
+          (method_name
+            (name)))
         (procedure_statement
           (procedure_kind)
           (procedure_attribute)
           (binding
             (binding_name
               (identifier))
-            (method_name))
-          (method_name))
+            (method_name
+              (name)))
+          (method_name
+            (name)))
         (procedure_statement
           (procedure_kind)
           (procedure_attribute)
           (binding
             (binding_name
               (assignment))
-            (method_name)))
+            (method_name
+              (name))))
         (procedure_statement
           (procedure_kind)
           (procedure_attribute)
@@ -1055,17 +1072,21 @@ end program
             (binding_name
               (operator
                 (operator_name)))
-            (method_name)))
+            (method_name
+              (name))))
         (procedure_statement
           (procedure_kind)
-          (method_name)
+          (method_name
+            (name))
           (binding
             (binding_name
               (identifier))
-            (method_name)))
+            (method_name
+              (name))))
         (procedure_statement
           (procedure_kind)
-          (method_name)))
+          (method_name
+            (name))))
       (end_type_statement
         (name)
         (end_of_statement)))
@@ -1184,7 +1205,8 @@ end program
           (procedure_kind)
           (procedure_interface)
           (procedure_attribute)
-          (method_name)))
+          (method_name
+            (name))))
       (end_type_statement
         (end_of_statement)))
     (interface
@@ -1231,11 +1253,13 @@ end program test
         (private_statement)
         (procedure_statement
           (procedure_kind)
-          (method_name))
+          (method_name
+            (name)))
         (procedure_statement
           (procedure_kind)
           (procedure_attribute)
-          (method_name)))
+          (method_name
+            (name))))
       (end_type_statement
         (name)
         (end_of_statement)))
diff --git a/test/corpus/cudafortran.txt b/test/corpus/cudafortran.txt
index 238d682..b351532 100644
--- a/test/corpus/cudafortran.txt
+++ b/test/corpus/cudafortran.txt
@@ -55,7 +55,8 @@ end function
       (end_of_statement))
     (comment)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (assignment_statement
       (identifier)
diff --git a/test/corpus/preprocessor.txt b/test/corpus/preprocessor.txt
index 5f3811a..336057e 100644
--- a/test/corpus/preprocessor.txt
+++ b/test/corpus/preprocessor.txt
@@ -490,7 +490,8 @@ end program
       name: (name)
       (end_of_statement))
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (identifier)
         (identifier)))
@@ -500,7 +501,8 @@ end program
         left: (identifier)
         right: (number_literal))
       (use_statement
-        (module_name))
+        (module_name
+          (name)))
       (end_of_statement))
     (end_program_statement
       (end_of_statement))))
@@ -551,7 +553,8 @@ end module foo
           (identifier)
           (procedure_statement
             (procedure_kind)
-            (method_name))))
+            (method_name
+              (name)))))
       (end_type_statement
         (name)
         (end_of_statement)))
@@ -833,7 +836,6 @@ end program
             (number_literal))
           (end_of_statement)))
       (case_statement
-        (default)
         (end_of_statement)
         (preproc_ifdef
           (identifier)
@@ -872,12 +874,14 @@ end module
         (end_of_statement))
       (procedure_statement
         (procedure_kind)
-        (method_name))
+        (method_name
+          (name)))
       (preproc_ifdef
         (identifier)
         (procedure_statement
           (procedure_kind)
-          (method_name)))
+          (method_name
+            (name))))
       (end_interface_statement
         (end_of_statement)))
     (end_module_statement
diff --git a/test/corpus/regressions.txt b/test/corpus/regressions.txt
index a5ddddf..0b7937a 100644
--- a/test/corpus/regressions.txt
+++ b/test/corpus/regressions.txt
@@ -26,14 +26,16 @@ end program example_padl
       (name)
       (end_of_statement))
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (identifier)
         (assignment)
         (defined_io_procedure)))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (identifier)))
     (end_of_statement)
diff --git a/test/corpus/statements.txt b/test/corpus/statements.txt
index 6a645aa..8ff5638 100644
--- a/test/corpus/statements.txt
+++ b/test/corpus/statements.txt
@@ -130,47 +130,57 @@ END PROGRAM
       (name)
       (end_of_statement))
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (identifier)
         (identifier)))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (identifier)))
     (end_of_statement)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (use_alias
           (local_name)
           (identifier))))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (use_alias
         (local_name)
         (identifier)))
     (end_of_statement)
     (use_statement
-      (module_name))
+      (module_name
+        (name)))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items))
     (end_of_statement)
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (use_alias
         (local_name)
         (identifier)))
@@ -1747,7 +1757,6 @@ END PROGRAM
             (string_literal)))
         (end_of_statement))
       (case_statement
-        (default)
         (end_of_statement)
         (write_statement
           (unit_identifier)
@@ -2418,7 +2427,6 @@ end subroutine print_decorated_numbers
               (type_member))))
         (end_of_statement))
       (type_statement
-        (default)
         (end_of_statement)
         (write_statement
           (unit_identifier)
@@ -2572,7 +2580,6 @@ end subroutine assumed_rank
             (string_literal)))
         (end_of_statement))
       (rank_statement
-        (default)
         (end_of_statement)
         (stop_statement
           (string_literal))
@@ -2769,7 +2776,8 @@ end module
       (name)
       (end_of_statement))
     (use_statement
-      (module_name)
+      (module_name
+        (name))
       (included_items
         (defined_io_procedure)
         (defined_io_procedure)))
@@ -2789,7 +2797,8 @@ end module
         (end_of_statement))
       (procedure_statement
         (procedure_kind)
-        (method_name))
+        (method_name
+          (name)))
       (end_interface_statement
         (end_of_statement)))
     (interface
@@ -2798,7 +2807,8 @@ end module
         (end_of_statement))
       (procedure_statement
         (procedure_kind)
-        (method_name))
+        (method_name
+          (name)))
       (end_interface_statement
         (defined_io_procedure)
         (end_of_statement)))
@@ -2815,7 +2825,8 @@ end module
           (binding
             (binding_name
               (defined_io_procedure))
-            (method_name)))
+            (method_name
+              (name))))
         (comment)
         (procedure_statement
           (procedure_kind)
@@ -2823,7 +2834,8 @@ end module
           (binding
             (binding_name
               (identifier))
-            (method_name))))
+            (method_name
+              (name)))))
       (end_type_statement
         (name)
         (end_of_statement)))
