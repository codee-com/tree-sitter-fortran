From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Diego Alonso <diego.alonso@appentra.com>
Date: Wed, 19 Mar 2025 16:02:59 +0100
Subject: Unhide `inline*` and `block*` nodes

---
 grammar.js                  |  26 +-
 test/corpus/expressions.txt |  53 ++--
 test/corpus/regressions.txt |  40 +--
 test/corpus/statements.txt  | 575 ++++++++++++++++++------------------
 4 files changed, 356 insertions(+), 338 deletions(-)

diff --git a/grammar.js b/grammar.js
index 9aba20e..d2b55d1 100644
--- a/grammar.js
+++ b/grammar.js
@@ -104,7 +104,7 @@ module.exports = grammar({
     [$.preproc_else_in_specification_part, $.program],
     [$.coarray_critical_statement, $.identifier],
     [$.format_statement, $.identifier],
-    [$._inline_if_statement, $.arithmetic_if_statement, $._block_if_statement, $.identifier],
+    [$.inline_if_statement, $.arithmetic_if_statement, $.block_if_statement, $.identifier],
     [$.cray_pointer_declaration, $.identifier],
     [$.unit_identifier, $.identifier],
   ],
@@ -1365,11 +1365,11 @@ module.exports = grammar({
     binary_op: $ => choice('+', '*', /(\.\w+\.|\w+)/),
 
     if_statement: $ => choice(
-      $._inline_if_statement,
-      $._block_if_statement
+      $.inline_if_statement,
+      $.block_if_statement
     ),
 
-    _inline_if_statement: $ => seq(
+    inline_if_statement: $ => seq(
       caseInsensitive('if'),
       $.parenthesized_expression,
       $._statements
@@ -1385,7 +1385,7 @@ module.exports = grammar({
       $.statement_label_reference,
     )),
 
-    _block_if_statement: $ => seq(
+    block_if_statement: $ => seq(
       optional($.block_label_start_expression),
       caseInsensitive('if'),
       $.parenthesized_expression,
@@ -1421,17 +1421,17 @@ module.exports = grammar({
     ),
 
     where_statement: $ => choice(
-      $._inline_where_statement,
-      $._block_where_statement
+      $.inline_where_statement,
+      $.block_where_statement
     ),
 
-    _inline_where_statement: $ => prec.right(seq(
+    inline_where_statement: $ => prec.right(seq(
       caseInsensitive('where'),
       $.parenthesized_expression,
       $._statements
     )),
 
-    _block_where_statement: $ => seq(
+    block_where_statement: $ => seq(
       optional($.block_label_start_expression),
       caseInsensitive('where'),
       $.parenthesized_expression,
@@ -1455,8 +1455,8 @@ module.exports = grammar({
     ),
 
     forall_statement: $ => choice(
-      $._inline_forall_statement,
-      $._block_forall_statement
+      $.inline_forall_statement,
+      $.block_forall_statement
     ),
 
     triplet_spec: $ => seq(
@@ -1479,12 +1479,12 @@ module.exports = grammar({
       ')'
     ),
 
-    _inline_forall_statement: $ => seq(
+    inline_forall_statement: $ => seq(
       $._forall_control_expression,
       $._statements
     ),
 
-    _block_forall_statement: $ => seq(
+    block_forall_statement: $ => seq(
       optional($.block_label_start_expression),
       $._forall_control_expression,
       $.end_of_statement,
diff --git a/test/corpus/expressions.txt b/test/corpus/expressions.txt
index 855fbcd..994158d 100644
--- a/test/corpus/expressions.txt
+++ b/test/corpus/expressions.txt
@@ -1264,42 +1264,43 @@ end subroutine foo
       (number_literal))
     (end_of_statement)
     (if_statement
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (number_literal))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (math_expression
-          (identifier)
-          (identifier)))
-      (end_of_statement)
-      (elseif_clause
+      (block_if_statement
         (parenthesized_expression
           (relational_expression
             (identifier)
             (number_literal)))
         (end_of_statement)
         (assignment_statement
-          (call_expression
-            (identifier)
-            (argument_list
-              (identifier)))
+          (identifier)
+          (number_literal))
+        (end_of_statement)
+        (assignment_statement
+          (identifier)
           (math_expression
             (identifier)
             (identifier)))
         (end_of_statement)
-        (print_statement
-          (format_identifier)
-          (output_item_list
-            (identifier)))
-        (end_of_statement))
-      (end_if_statement))
+        (elseif_clause
+          (parenthesized_expression
+            (relational_expression
+              (identifier)
+              (number_literal)))
+          (end_of_statement)
+          (assignment_statement
+            (call_expression
+              (identifier)
+              (argument_list
+                (identifier)))
+            (math_expression
+              (identifier)
+              (identifier)))
+          (end_of_statement)
+          (print_statement
+            (format_identifier)
+            (output_item_list
+              (identifier)))
+          (end_of_statement))
+        (end_if_statement)))
     (end_of_statement)
     (end_program_statement
       (end_of_statement)))
diff --git a/test/corpus/regressions.txt b/test/corpus/regressions.txt
index d6b3f37..a5ddddf 100644
--- a/test/corpus/regressions.txt
+++ b/test/corpus/regressions.txt
@@ -97,23 +97,24 @@ end program foo
       (name)
       (end_of_statement))
     (if_statement
-      (block_label_start_expression)
-      (parenthesized_expression
-        (boolean_literal))
-      (end_of_statement)
-      (subroutine_call
-        (identifier)
-        (argument_list))
-      (end_of_statement)
-      (else_clause
-        (block_label)
+      (block_if_statement
+        (block_label_start_expression)
+        (parenthesized_expression
+          (boolean_literal))
         (end_of_statement)
         (subroutine_call
           (identifier)
           (argument_list))
-        (end_of_statement))
-      (end_if_statement
-        (block_label)))
+        (end_of_statement)
+        (else_clause
+          (block_label)
+          (end_of_statement)
+          (subroutine_call
+            (identifier)
+            (argument_list))
+          (end_of_statement))
+        (end_if_statement
+          (block_label))))
     (end_of_statement)
     (end_program_statement
       (name)
@@ -140,14 +141,15 @@ end program
       (name)
       (end_of_statement))
     (if_statement
-      (parenthesized_expression
-        (boolean_literal))
-      (end_of_statement)
-      (elseif_clause
+      (block_if_statement
         (parenthesized_expression
           (boolean_literal))
-        (end_of_statement))
-      (end_if_statement))
+        (end_of_statement)
+        (elseif_clause
+          (parenthesized_expression
+            (boolean_literal))
+          (end_of_statement))
+        (end_if_statement)))
     (end_of_statement)
     (end_program_statement
       (end_of_statement))))
diff --git a/test/corpus/statements.txt b/test/corpus/statements.txt
index fe7ec84..604ca98 100644
--- a/test/corpus/statements.txt
+++ b/test/corpus/statements.txt
@@ -887,10 +887,11 @@ END PROGRAM
         (number_literal))
       (end_of_statement)
       (if_statement
-        (parenthesized_expression
-          (identifier))
-        (keyword_statement
-          (statement_label_reference)))
+        (inline_if_statement
+          (parenthesized_expression
+            (identifier))
+          (keyword_statement
+            (statement_label_reference))))
       (end_of_statement)
       (statement_label)
       (end_do_loop_statement))
@@ -1150,67 +1151,31 @@ END PROGRAM
       (name)
       (end_of_statement))
     (if_statement
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (assignment_statement
-        (identifier)
-        (number_literal)))
-    (end_of_statement)
-    (if_statement
-      (parenthesized_expression
-        (logical_expression
+      (inline_if_statement
+        (parenthesized_expression
           (relational_expression
             (identifier)
-            (number_literal))
-          (relational_expression
-            (number_literal)
-            (identifier))))
-      (assignment_statement
-        (identifier)
-        (number_literal)))
+            (number_literal)))
+        (assignment_statement
+          (identifier)
+          (number_literal))))
     (end_of_statement)
     (if_statement
-      (parenthesized_expression
-        (relational_expression
-          (call_expression
-            (identifier)
-            (argument_list
-              (extent_specifier
-                (number_literal)
-                (number_literal))))
-          (call_expression
-            (identifier)
-            (argument_list
-              (string_literal)))))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (number_literal))
-      (end_of_statement)
-      (elseif_clause
+      (inline_if_statement
         (parenthesized_expression
-          (relational_expression
-            (call_expression
-              (identifier)
-              (argument_list
-                (extent_specifier
-                  (number_literal)
-                  (number_literal))))
-            (call_expression
+          (logical_expression
+            (relational_expression
               (identifier)
-              (argument_list
-                (call_expression
-                  (identifier)
-                  (argument_list
-                    (number_literal)))))))
-        (end_of_statement)
+              (number_literal))
+            (relational_expression
+              (number_literal)
+              (identifier))))
         (assignment_statement
           (identifier)
-          (number_literal))
-        (end_of_statement))
-      (elseif_clause
+          (number_literal))))
+    (end_of_statement)
+    (if_statement
+      (block_if_statement
         (parenthesized_expression
           (relational_expression
             (call_expression
@@ -1222,71 +1187,112 @@ END PROGRAM
             (call_expression
               (identifier)
               (argument_list
-                (call_expression
-                  (identifier)
-                  (argument_list
-                    (number_literal)))))))
-        (end_of_statement))
-      (else_clause
+                (string_literal)))))
         (end_of_statement)
         (assignment_statement
           (identifier)
           (number_literal))
-        (end_of_statement))
-      (end_if_statement))
+        (end_of_statement)
+        (elseif_clause
+          (parenthesized_expression
+            (relational_expression
+              (call_expression
+                (identifier)
+                (argument_list
+                  (extent_specifier
+                    (number_literal)
+                    (number_literal))))
+              (call_expression
+                (identifier)
+                (argument_list
+                  (call_expression
+                    (identifier)
+                    (argument_list
+                      (number_literal)))))))
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (number_literal))
+          (end_of_statement))
+        (elseif_clause
+          (parenthesized_expression
+            (relational_expression
+              (call_expression
+                (identifier)
+                (argument_list
+                  (extent_specifier
+                    (number_literal)
+                    (number_literal))))
+              (call_expression
+                (identifier)
+                (argument_list
+                  (call_expression
+                    (identifier)
+                    (argument_list
+                      (number_literal)))))))
+          (end_of_statement))
+        (else_clause
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (number_literal))
+          (end_of_statement))
+        (end_if_statement)))
     (end_of_statement)
     (if_statement
-      (block_label_start_expression)
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (number_literal))
-      (end_of_statement)
-      (elseif_clause
+      (block_if_statement
+        (block_label_start_expression)
         (parenthesized_expression
           (relational_expression
             (identifier)
             (number_literal)))
-        (block_label)
         (end_of_statement)
         (assignment_statement
           (identifier)
           (number_literal))
         (end_of_statement)
-        (if_statement
+        (elseif_clause
           (parenthesized_expression
-            (call_expression
+            (relational_expression
               (identifier)
-              (argument_list
-                (extent_specifier
-                  (number_literal)
-                  (number_literal)))))
+              (number_literal)))
+          (block_label)
           (end_of_statement)
           (assignment_statement
             (identifier)
             (number_literal))
           (end_of_statement)
-          (else_clause
-            (end_of_statement)
-            (assignment_statement
-              (identifier)
-              (number_literal))
-            (end_of_statement))
-          (end_if_statement))
-        (end_of_statement))
-      (else_clause
-        (block_label)
-        (end_of_statement)
-        (assignment_statement
-          (identifier)
-          (number_literal))
-        (end_of_statement))
-      (end_if_statement
-        (block_label)))
+          (if_statement
+            (block_if_statement
+              (parenthesized_expression
+                (call_expression
+                  (identifier)
+                  (argument_list
+                    (extent_specifier
+                      (number_literal)
+                      (number_literal)))))
+              (end_of_statement)
+              (assignment_statement
+                (identifier)
+                (number_literal))
+              (end_of_statement)
+              (else_clause
+                (end_of_statement)
+                (assignment_statement
+                  (identifier)
+                  (number_literal))
+                (end_of_statement))
+              (end_if_statement)))
+          (end_of_statement))
+        (else_clause
+          (block_label)
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (number_literal))
+          (end_of_statement))
+        (end_if_statement
+          (block_label))))
     (end_of_statement)
     (end_program_statement
       (end_of_statement))))
@@ -1326,35 +1332,19 @@ end program
       (name)
       (end_of_statement))
     (where_statement
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (assignment_statement
-        (identifier)
-        (math_expression
+      (inline_where_statement
+        (parenthesized_expression
+          (relational_expression
+            (identifier)
+            (number_literal)))
+        (assignment_statement
           (identifier)
-          (identifier))))
+          (math_expression
+            (identifier)
+            (identifier)))))
     (end_of_statement)
     (where_statement
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (math_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (math_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (elsewhere_clause
+      (block_where_statement
         (parenthesized_expression
           (relational_expression
             (identifier)
@@ -1365,50 +1355,69 @@ end program
           (math_expression
             (identifier)
             (number_literal)))
-        (end_of_statement))
-      (elsewhere_clause
         (end_of_statement)
         (assignment_statement
           (identifier)
-          (boolean_literal))
-        (end_of_statement))
-      (end_where_statement))
+          (math_expression
+            (identifier)
+            (number_literal)))
+        (end_of_statement)
+        (elsewhere_clause
+          (parenthesized_expression
+            (relational_expression
+              (identifier)
+              (number_literal)))
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (math_expression
+              (identifier)
+              (number_literal)))
+          (end_of_statement))
+        (elsewhere_clause
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (boolean_literal))
+          (end_of_statement))
+        (end_where_statement)))
     (end_of_statement)
     (where_statement
-      (block_label_start_expression)
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (assignment_statement
-        (identifier)
-        (math_expression
-          (identifier)
-          (number_literal)))
-      (end_of_statement)
-      (elsewhere_clause
+      (block_where_statement
+        (block_label_start_expression)
         (parenthesized_expression
           (relational_expression
             (identifier)
             (number_literal)))
-        (block_label)
         (end_of_statement)
         (assignment_statement
           (identifier)
           (math_expression
             (identifier)
             (number_literal)))
-        (end_of_statement))
-      (elsewhere_clause
-        (block_label)
         (end_of_statement)
-        (assignment_statement
-          (identifier)
-          (boolean_literal))
-        (end_of_statement))
-      (end_where_statement
-        (block_label)))
+        (elsewhere_clause
+          (parenthesized_expression
+            (relational_expression
+              (identifier)
+              (number_literal)))
+          (block_label)
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (math_expression
+              (identifier)
+              (number_literal)))
+          (end_of_statement))
+        (elsewhere_clause
+          (block_label)
+          (end_of_statement)
+          (assignment_statement
+            (identifier)
+            (boolean_literal))
+          (end_of_statement))
+        (end_where_statement
+          (block_label))))
     (end_of_statement)
     (end_program_statement
       (end_of_statement))))
@@ -1443,167 +1452,172 @@ END PROGRAM
       (name)
       (end_of_statement))
     (forall_statement
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (identifier))
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (identifier))
-      (relational_expression
-        (call_expression
+      (inline_forall_statement
+        (triplet_spec
           (identifier)
-          (argument_list
-            (identifier)
-            (identifier)))
-        (number_literal))
-      (assignment_statement
-        (call_expression
+          (number_literal)
+          (identifier))
+        (triplet_spec
           (identifier)
-          (argument_list
-            (identifier)
-            (identifier)))
-        (math_expression
           (number_literal)
+          (identifier))
+        (relational_expression
           (call_expression
             (identifier)
             (argument_list
               (identifier)
-              (identifier))))))
-    (end_of_statement)
-    (forall_statement
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (number_literal))
-      (pointer_association_statement
-        (derived_type_member_expression
+              (identifier)))
+          (number_literal))
+        (assignment_statement
           (call_expression
             (identifier)
             (argument_list
+              (identifier)
               (identifier)))
-          (type_member))
-        (call_expression
-          (identifier)
-          (argument_list
-            (math_expression
-              (number_literal)
-              (call_expression
+          (math_expression
+            (number_literal)
+            (call_expression
+              (identifier)
+              (argument_list
                 (identifier)
-                (argument_list
-                  (math_expression
-                    (identifier)
-                    (number_literal))
-                  (number_literal))))))))
+                (identifier)))))))
     (end_of_statement)
     (forall_statement
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (identifier))
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (identifier))
-      (end_of_statement)
-      (where_statement
-        (parenthesized_expression
-          (relational_expression
+      (inline_forall_statement
+        (triplet_spec
+          (identifier)
+          (number_literal)
+          (number_literal))
+        (pointer_association_statement
+          (derived_type_member_expression
             (call_expression
               (identifier)
               (argument_list
-                (identifier)
                 (identifier)))
-            (number_literal)))
-        (assignment_statement
+            (type_member))
           (call_expression
             (identifier)
             (argument_list
-              (identifier)
-              (identifier)))
-          (math_expression
-            (number_literal)
-            (call_expression
-              (identifier)
-              (argument_list
-                (identifier)
-                (identifier))))))
-      (end_of_statement)
-      (end_forall_statement))
+              (math_expression
+                (number_literal)
+                (call_expression
+                  (identifier)
+                  (argument_list
+                    (math_expression
+                      (identifier)
+                      (number_literal))
+                    (number_literal)))))))))
     (end_of_statement)
     (forall_statement
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (math_expression
+      (block_forall_statement
+        (triplet_spec
           (identifier)
-          (number_literal)))
-      (triplet_spec
-        (identifier)
-        (number_literal)
-        (math_expression
+          (number_literal)
+          (identifier))
+        (triplet_spec
           (identifier)
-          (number_literal)))
-      (relational_expression
-        (call_expression
+          (number_literal)
+          (identifier))
+        (end_of_statement)
+        (where_statement
+          (inline_where_statement
+            (parenthesized_expression
+              (relational_expression
+                (call_expression
+                  (identifier)
+                  (argument_list
+                    (identifier)
+                    (identifier)))
+                (number_literal)))
+            (assignment_statement
+              (call_expression
+                (identifier)
+                (argument_list
+                  (identifier)
+                  (identifier)))
+              (math_expression
+                (number_literal)
+                (call_expression
+                  (identifier)
+                  (argument_list
+                    (identifier)
+                    (identifier)))))))
+        (end_of_statement)
+        (end_forall_statement)))
+    (end_of_statement)
+    (forall_statement
+      (block_forall_statement
+        (triplet_spec
           (identifier)
-          (argument_list
+          (number_literal)
+          (math_expression
             (identifier)
-            (identifier)))
-        (number_literal))
-      (end_of_statement)
-      (assignment_statement
-        (call_expression
+            (number_literal)))
+        (triplet_spec
           (identifier)
-          (argument_list
+          (number_literal)
+          (math_expression
             (identifier)
-            (identifier)))
-        (math_expression
+            (number_literal)))
+        (relational_expression
+          (call_expression
+            (identifier)
+            (argument_list
+              (identifier)
+              (identifier)))
+          (number_literal))
+        (end_of_statement)
+        (assignment_statement
+          (call_expression
+            (identifier)
+            (argument_list
+              (identifier)
+              (identifier)))
           (math_expression
             (math_expression
-              (call_expression
-                (identifier)
-                (argument_list
+              (math_expression
+                (call_expression
                   (identifier)
-                  (math_expression
+                  (argument_list
                     (identifier)
-                    (number_literal))))
+                    (math_expression
+                      (identifier)
+                      (number_literal))))
+                (call_expression
+                  (identifier)
+                  (argument_list
+                    (identifier)
+                    (math_expression
+                      (identifier)
+                      (number_literal)))))
               (call_expression
                 (identifier)
                 (argument_list
-                  (identifier)
                   (math_expression
                     (identifier)
-                    (number_literal)))))
+                    (number_literal))
+                  (identifier))))
             (call_expression
               (identifier)
               (argument_list
                 (math_expression
                   (identifier)
                   (number_literal))
-                (identifier))))
+                (identifier)))))
+        (end_of_statement)
+        (assignment_statement
           (call_expression
             (identifier)
             (argument_list
-              (math_expression
-                (identifier)
-                (number_literal))
-              (identifier)))))
-      (end_of_statement)
-      (assignment_statement
-        (call_expression
-          (identifier)
-          (argument_list
-            (identifier)
-            (identifier)))
-        (call_expression
-          (identifier)
-          (argument_list
+              (identifier)
+              (identifier)))
+          (call_expression
             (identifier)
-            (identifier))))
-      (end_of_statement)
-      (end_forall_statement))
+            (argument_list
+              (identifier)
+              (identifier))))
+        (end_of_statement)
+        (end_forall_statement)))
     (end_of_statement)
     (end_program_statement
       (end_of_statement))))
@@ -3496,19 +3510,20 @@ end program test
         (identifier)))
     (end_of_statement)
     (if_statement
-      (parenthesized_expression
-        (relational_expression
-          (identifier)
-          (number_literal)))
-      (assignment_statement
-        (coarray_expression
-          (identifier)
-          (coarray_index
-            (number_literal)
-            (keyword_argument
-              (identifier)
-              (identifier))))
-        (identifier)))
+      (inline_if_statement
+        (parenthesized_expression
+          (relational_expression
+            (identifier)
+            (number_literal)))
+        (assignment_statement
+          (coarray_expression
+            (identifier)
+            (coarray_index
+              (number_literal)
+              (keyword_argument
+                (identifier)
+                (identifier))))
+          (identifier))))
     (end_of_statement)
     (allocate_statement
       (coarray_allocation
